### 28. Hash

é›œæ¹Šå‡½æ•¸ï¼ˆhash functionï¼‰æ˜¯ä¸€å€‹å¯†ç¢¼å­¸æ¦‚å¿µï¼Œå®ƒå¯ä»¥å°‡ä»»æ„é•·åº¦çš„è¨Šæ¯è½‰æ›ç‚ºä¸€å€‹å›ºå®šé•·åº¦çš„å€¼ï¼Œé€™å€‹å€¼ä¹Ÿç¨±ç‚ºé›œæ¹Šï¼ˆhashï¼‰ã€‚

#### hash ç‰¹é»

ä¸€å€‹å¥½çš„å“ˆå¸Œå‡½æ•¸æ‡‰è©²å…·æœ‰ä»¥ä¸‹å¹¾å€‹ç‰¹æ€§ï¼š

- å–®å‘æ€§ï¼šå¾è¼¸å…¥çš„è¨Šæ¯åˆ°å®ƒçš„é›œæ¹Šçš„æ­£å‘é‹ç®—ç°¡å–®ä¸”å”¯ä¸€ç¢ºå®šï¼Œè€Œåéä¾†éå¸¸é›£ï¼Œåªèƒ½é æš´åŠ›æšèˆ‰ã€‚
- éˆæ•åº¦ï¼šè¼¸å…¥çš„è¨Šæ¯æ”¹è®Šä¸€é»å°å®ƒçš„å“ˆå¸Œæ”¹è®Šå¾ˆå¤§ã€‚
- é«˜æ•ˆç‡ï¼šå¾è¼¸å…¥çš„è¨Šæ¯åˆ°å“ˆå¸Œçš„é‹ç®—é«˜æ•ˆç‡ã€‚
- å‡ä¸€æ€§ï¼šæ¯å€‹é›œæ¹Šå€¼è¢«å–åˆ°çš„æ©Ÿç‡æ‡‰è©²åŸºæœ¬ä¸Šç›¸ç­‰ã€‚
- æŠ—ç¢°æ’æ€§ï¼š
    - å¼±æŠ—ç¢°æ’æ€§ï¼šçµ¦å®šä¸€å€‹è¨Šæ¯xï¼Œæ‰¾å‡ºå¦ä¸€å€‹è¨Šæ¯x'ï¼Œä½¿å¾—hash(x) = hash(x')
    - æ˜¯å›°é›£çš„ã€‚å¼·æŠ—ç¢°æ’æ€§ï¼šæ‰¾åˆ°ä»»æ„xå’Œx'ï¼Œä½¿å¾—hash(x) = hash(x')æ˜¯å›°é›£çš„ã€‚

#### hash æ‡‰ç”¨

- ç”¢ç”Ÿè³‡æ–™å”¯ä¸€æ¨™è­˜
- åŠ å¯†ç°½å
- å®‰å…¨åŠ å¯†

Keccak256å‡½æ•¸æ˜¯Solidityä¸­æœ€å¸¸ç”¨çš„é›œæ¹Šå‡½æ•¸ï¼Œç”¨æ³•éå¸¸ç°¡å–®ï¼š

```
å“ˆå¸Œ = keccak256(æ•°æ®);
```

#### Keccak256å’ŒSHA3

é€™æ˜¯ä¸€å€‹å¾ˆæœ‰è¶£çš„äº‹ï¼š

- sha3ç”±keccakæ¨™æº–åŒ–è€Œä¾†ï¼Œåœ¨è¨±å¤šå ´åˆä¸‹Keccakå’ŒSHA3æ˜¯åŒç¾©è©ï¼Œä½†åœ¨2015å¹´8æœˆSHA3æœ€çµ‚å®Œæˆæ¨™æº–åŒ–æ™‚ï¼ŒNISTèª¿æ•´äº†å¡«å……æ¼”ç®—æ³•ã€‚æ‰€ä»¥SHA3å°±å’Œkeccakè¨ˆç®—çš„çµæœä¸ä¸€æ¨£ï¼Œé€™é»åœ¨å¯¦éš›é–‹ç™¼ä¸Šè¦æ³¨æ„ã€‚

- ä»¥å¤ªåŠåœ¨é–‹ç™¼çš„æ™‚å€™sha3é‚„åœ¨æ¨™æº–åŒ–ä¸­ï¼Œæ‰€ä»¥æ¡ç”¨äº†keccakï¼Œæ‰€ä»¥Ethereumå’ŒSolidityæ™ºèƒ½åˆç´„ç¨‹å¼ç¢¼ä¸­çš„SHA3æ˜¯æŒ‡Keccak256ï¼Œè€Œä¸æ˜¯æ¨™æº–çš„NIST-SHA3ï¼Œç‚ºäº†é¿å…æ··æ·†ï¼Œç›´æ¥åœ¨åˆç´„ç¨‹å¼ç¢¼ä¸­å¯«æˆKeccak256æ˜¯æœ€æ¸…æ™°çš„ã€‚

ğŸ§‘â€ğŸ’» Keccak256 æ‰æ˜¯ eth çš„æ¨™æº–


#### ç”¢ç”Ÿè³‡æ–™å”¯ä¸€ ğŸ§‘â€ğŸ’» 

```
function hash(
    uint _num,
    string memory _string,
    address _addr
    ) public pure returns (bytes32) {
    return keccak256(abi.encodePacked(_num, _string, _addr));
}
```

#### å¼±æŠ—ç¢°æ’æ€§ ğŸ§‘â€ğŸ’» 

æˆ‘å€‘ç”¨keccak256ç¤ºç¯„ä¸€ä¸‹ä¹‹å‰è¬›åˆ°çš„å¼±æŠ—ç¢°æ’æ€§ï¼Œå³çµ¦å®šä¸€å€‹è¨Šæ¯xï¼Œæ‰¾åˆ°å¦ä¸€å€‹è¨Šæ¯x'ï¼Œä½¿å¾—hash(x) = hash(x')æ˜¯å›°é›£çš„ã€‚

æˆ‘å€‘çµ¦å®šä¸€å€‹è¨Šæ¯0xAAï¼Œè©¦åœ–å»æ‰¾å¦ä¸€å€‹è¨Šæ¯ï¼Œä½¿å¾—å®ƒå€‘çš„å“ˆå¸Œå€¼ç›¸ç­‰ï¼š

```
// å¼±æŠ—ç¢°æ’æ€§
function weak(
    string memory string1
    )public view returns (bool){
    return keccak256(abi.encodePacked(string1)) == _msg;
}
```

`Solidity`æœ€å¸¸ç”¨çš„é›œæ¹Šå‡½æ•¸`keccak256`

hash å€¼å¦‚æœç›¸åŒï¼Œä»£è¡¨ä¸‹è¼‰çš„æª”æ¡ˆæ˜¯ä¸€æ¨£çš„ï¼ˆåŸä¾†é€™å¥è©±æ˜¯æœ‰å¾…å•†è­°çš„ï¼‰
// åŸå› 
- æœ‰å¯èƒ½æ˜¯ä¸åŒçš„æª”æ¡ˆï¼Œä½†æ˜¯ hash å€¼ç›¸åŒ




#### 29. å‡½æ•°é€‰æ‹©å™¨Selector

### å‡½æ•¸é¸æ“‡

ç™¼é€çš„`calldata`ä¸­å‰"4å€‹ä½å…ƒçµ„"æ˜¯`selectorï¼ˆå‡½æ•¸é¸æ“‡å™¨ï¼‰`ã€‚é€™ä¸€è¬›ï¼Œæˆ‘å€‘å°‡ä»‹ç´¹`selector`æ˜¯ä»€éº¼ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ã€‚

`msg.data`æ˜¯`Solidity`ä¸­çš„ä¸€å€‹å…¨åŸŸè®Šé‡ï¼Œå€¼ç‚ºå®Œæ•´çš„`calldata`ï¼ˆå‘¼å«å‡½æ•¸æ™‚å‚³å…¥çš„è³‡æ–™ï¼‰ã€‚

åœ¨ä¸‹é¢çš„ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘å¯ä»¥é€é`Logäº‹ä»¶`ä¾†è¼¸å‡ºå‘¼å«`mint`å‡½æ•¸çš„`calldata`ï¼š

```
// event è¿”å›msg.data
event Log(bytes data);

function mint(address to) external{
    emit Log(msg.data);
}
```

ç•¶åƒæ•¸0x2c44b726ADF1963cA47Af88B284C06f30380fC78ç‚ºæ™‚ï¼Œè¼¸å‡ºçš„calldataç‚º

```
0x6a6278420000000000000000000000002c44b726adf1963ca47af88b284c06f30380fc78
```

åˆ‡å‰²ä¸€ä¸‹

```
å‰4ä¸ªå­—èŠ‚ä¸ºå‡½æ•°é€‰æ‹©å™¨selectorï¼š
0x6a627842

åé¢32ä¸ªå­—èŠ‚ä¸ºè¾“å…¥çš„å‚æ•°ï¼š
0x0000000000000000000000002c44b726adf1963ca47af88b284c06f30380fc78
```

`å…¶å¯¦calldataå°±æ˜¯å‘Šè¨´æ™ºèƒ½åˆç´„ï¼Œæˆ‘è¦å‘¼å«å“ªå€‹å‡½æ•¸ï¼Œä»¥åŠåƒæ•¸æ˜¯ä»€éº¼ã€‚`

#### method idã€selectorå’Œå‡½æ•¸ç°½å

`method id`å®šç¾©ç‚ºå‡½æ•°ç­¾åçš„`Keccaké›œæ¹Šå¾Œçš„å‰4å€‹ä½å…ƒçµ„`ï¼Œç•¶selectorèˆ‡method idç›¸ç¬¦æ™‚ï¼Œå³è¡¨ç¤ºå‘¼å«è©²å‡½æ•¸ï¼Œé‚£éº¼å‡½æ•°ç­¾åæ˜¯ä»€éº¼ï¼Ÿ

èˆ‰å€‹ä¾‹å­ï¼Œä¸Šé¢ç¨‹å¼ç¢¼ä¸­mintçš„å‡½æ•¸ç°½åç‚º`"mint(address)"`ã€‚åœ¨åŒä¸€å€‹æ™ºèƒ½åˆç´„ä¸­ï¼Œä¸åŒçš„å‡½æ•¸æœ‰ä¸åŒçš„å‡½æ•¸ç°½åï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é€éå‡½æ•¸ç°½åä¾†ç¢ºå®šè¦å‘¼å«å“ªå€‹å‡½æ•¸ã€‚

`æ³¨æ„ï¼Œåœ¨å‡½æ•¸ç°½åä¸­ï¼Œuintå’Œintè¦å¯«ç‚ºuint256å’Œint256ã€‚`

`è¨ˆç®—method idæ™‚ï¼Œéœ€è¦é€éå‡½æ•¸åç¨±å’Œå‡½æ•¸çš„åƒæ•¸é¡å‹ä¾†è¨ˆç®—ã€‚`

é¡å‹ï¼š

1. åŸºç¤é¡å‹åƒæ•¸

  ```solidity
  Â  Â  // elementaryï¼ˆåŸºç¡€ï¼‰ç±»å‹å‚æ•°selector
  Â  Â  // è¾“å…¥ï¼šparam1: 1ï¼Œparam2: 0
  Â  Â  // elementaryParamSelector(uint256,bool) : 0x3ec37834
  Â  Â  function elementaryParamSelector(uint256 param1, bool param2) external returns(bytes4 selectorWithElementaryParam){
  Â  Â  Â  Â  emit SelectorEvent(this.elementaryParamSelector.selector);
  Â  Â  Â  Â  return bytes4(keccak256("elementaryParamSelector(uint256,bool)"));
  Â  Â  }
  ```
2. åŸºç¤é¡å‹åƒæ•¸

```solidity
Â  Â  // fixed sizeï¼ˆå›ºå®šé•¿åº¦ï¼‰ç±»å‹å‚æ•°selector
Â  Â  // è¾“å…¥ï¼š param1: [1,2,3]
Â  Â  // fixedSizeParamSelector(uint256[3]) : 0xead6b8bd
Â  Â  function fixedSizeParamSelector(uint256[3] memory param1) external returns(bytes4 selectorWithFixedSizeParam){
Â  Â  Â  Â  emit SelectorEvent(this.fixedSizeParamSelector.selector);
Â  Â  Â  Â  return bytes4(keccak256("fixedSizeParamSelector(uint256[3])"));
Â  Â  }
```

3. å‹•æ…‹é¡å‹åƒæ•¸

```solidity
Â  Â  // non-fixed sizeï¼ˆå¯å˜é•¿åº¦ï¼‰ç±»å‹å‚æ•°selector
Â  Â  // è¾“å…¥ï¼š param1: [1,2,3]ï¼Œ param2: "abc"
Â  Â  // nonFixedSizeParamSelector(uint256[],string) : 0xf0ca01de
Â  Â  function nonFixedSizeParamSelector(uint256[] memory param1,string memory param2) external returns(bytes4 selectorWithNonFixedSizeParam){
Â  Â  Â  Â  emit SelectorEvent(this.nonFixedSizeParamSelector.selector);
Â  Â  Â  Â  return bytes4(keccak256("nonFixedSizeParamSelector(uint256[],string)"));
Â  Â  }
```

4. æ˜ å°„é¡å‹
  
  ```solidity
  contract DemoContract {
Â  Â  // empty contract
}

contract Selector{
Â  Â  // Struct User
Â  Â  struct User {
Â  Â  Â  Â  uint256 uid;
Â  Â  Â  Â  bytes name;
Â  Â  }
Â  Â  // Enum School
Â  Â  enum School { SCHOOL1, SCHOOL2, SCHOOL3 }
Â  Â  ...
Â  Â  // mappingï¼ˆæ˜ å°„ï¼‰ç±»å‹å‚æ•°selector
Â  Â  // è¾“å…¥ï¼šdemo: 0x9D7f74d0C41E726EC95884E0e97Fa6129e3b5E99ï¼Œ user: [1, "0xa0b1"], count: [1,2,3], mySchool: 1
Â  Â  // mappingParamSelector(address,(uint256,bytes),uint256[],uint8) : 0xe355b0ce
Â  Â  function mappingParamSelector(DemoContract demo, User memory user, uint256[] memory count, School mySchool) external returns(bytes4 selectorWithMappingParam){
Â  Â  Â  Â  emit SelectorEvent(this.mappingParamSelector.selector);
Â  Â  Â  Â  return bytes4(keccak256("mappingParamSelector(address,(uint256,bytes),uint256[],uint8)"));
Â  Â  }
Â  Â  ...
}
```
#### ä½¿ç”¨å‡½æ•¸é¸æ“‡å™¨

```
    // ä½¿ç”¨selectoræ¥è°ƒç”¨å‡½æ•°
    function callWithSignature() external{
    ...
        // è°ƒç”¨elementaryParamSelectorå‡½æ•°
        (bool success1, bytes memory data1) = address(this).call(abi.encodeWithSelector(0x3ec37834, 1, 0));
    ...
    }
```
`call method_id` ä¾†å‘¼å«å‡½æ•¸


### 30. Try Catch


`try-catch`æ˜¯ç¾ä»£ç¨‹å¼èªè¨€å¹¾ä¹éƒ½æœ‰çš„è™•ç†ç•°å¸¸çš„ä¸€ç¨®æ¨™æº–æ–¹å¼ï¼Œ`Solidity0.6`ç‰ˆæœ¬ä¹Ÿæ·»åŠ äº†å®ƒ

åœ¨Solidityä¸­ï¼Œtry-catchåªèƒ½è¢«ç”¨æ–¼`externalå‡½æ•¸`æˆ–å‰µå»ºåˆç´„æ™‚`constructorï¼ˆè¢«è¦–ç‚ºexternalå‡½æ•¸ï¼‰`çš„å‘¼å«ã€‚åŸºæœ¬èªæ³•å¦‚ä¸‹ï¼š

```
try externalContract.f() {
    // callæˆåŠŸçš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
} catch {
    // callå¤±è´¥çš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
}
```
å…¶ä¸­`externalContract.f()`æ˜¯æŸå€‹å¤–éƒ¨åˆç´„çš„å‡½æ•¸èª¿ç”¨ï¼Œtryæ¨¡çµ„åœ¨èª¿ç”¨æˆåŠŸçš„æƒ…æ³ä¸‹é‹è¡Œï¼Œè€Œcatchæ¨¡çµ„å‰‡åœ¨èª¿ç”¨å¤±æ•—æ™‚é‹è¡Œã€‚

åŒæ¨£å¯ä»¥ä½¿ç”¨`this.f()`ä¾†æ›¿ä»£`externalContract.f()`ï¼Œ`this.f()`ä¹Ÿè¢«è¦–ä½œç‚ºå¤–éƒ¨èª¿ç”¨ï¼Œä½†ä¸å¯åœ¨æ§‹é€ å‡½æ•¸ä¸­ä½¿ç”¨ï¼Œå› ç‚ºæ­¤æ™‚åˆç´„é‚„æœªå‰µå»ºã€‚

å¦‚æœå‘¼å«çš„å‡½æ•¸æœ‰å‚³å›å€¼ï¼Œé‚£éº¼å¿…é ˆåœ¨tryä¹‹å¾Œè²æ˜`returns(returnType val)`ï¼Œä¸¦ä¸”åœ¨tryæ¨¡çµ„ä¸­å¯ä»¥ä½¿ç”¨å‚³å›çš„è®Šæ•¸ï¼›å¦‚æœæ˜¯å»ºç«‹åˆç´„ï¼Œé‚£éº¼å‚³å›å€¼å°±æ˜¯æ–°å»ºç«‹çš„åˆç´„è®Šæ•¸ã€‚

```
try externalContract.f() returns(returnType val){
    // callæˆåŠŸçš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
} catch {
    // callå¤±è´¥çš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
}
```

```
try externalContract.f() returns(returnType){
    // callæˆåŠŸçš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
} catch Error(string memory /*reason*/) {
    // æ•è·revert("reasonString") å’Œ require(false, "reasonString")
} catch Panic(uint /*errorCode*/) {
    // æ•è·Panicå¯¼è‡´çš„é”™è¯¯ ä¾‹å¦‚assertå¤±è´¥ æº¢å‡º é™¤é›¶ æ•°ç»„è®¿é—®è¶Šç•Œ
} catch (bytes memory /*lowLevelData*/) {
    // å¦‚æœå‘ç”Ÿäº†revertä¸”ä¸Šé¢2ä¸ªå¼‚å¸¸ç±»å‹åŒ¹é…éƒ½å¤±è´¥äº† ä¼šè¿›å…¥è¯¥åˆ†æ”¯
    // ä¾‹å¦‚revert() require(false) revertè‡ªå®šä¹‰ç±»å‹çš„error
}
```
EX: OnlyEven
æˆ‘å€‘å»ºç«‹ä¸€å€‹å¤–éƒ¨åˆç´„OnlyEvenï¼Œä¸¦ä½¿ç”¨try-catchä¾†è™•ç†ç•°å¸¸ï¼š

```
contract OnlyEven{
    constructor(uint a){
        require(a != 0, "invalid number");
        assert(a != 1);
    }

    function onlyEven(uint256 b) external pure returns(bool success){
        // è¾“å…¥å¥‡æ•°æ—¶revert
        require(b % 2 == 0, "Ups! Reverting");
        success = true;
    }
}
```

#### è™•ç†å¤–éƒ¨å‡½æ•¸å‘¼å«

```
// æˆåŠŸevent
event SuccessEvent();

// å¤±è´¥event
event CatchEvent(string message);
event CatchByte(bytes data);

// å£°æ˜OnlyEvenåˆçº¦å˜é‡
OnlyEven even;

constructor() {
    even = new OnlyEven(2);
}


// åœ¨external callä¸­ä½¿ç”¨try-catch
function execute(uint amount) external returns (bool success) {
    try even.onlyEven(amount) returns(bool _success){
        // callæˆåŠŸçš„æƒ…å†µä¸‹
        emit SuccessEvent();
        return _success;
    } catch Error(string memory reason){
        // callä¸æˆåŠŸçš„æƒ…å†µä¸‹
        emit CatchEvent(reason);
    }
}

// åœ¨åˆ›å»ºæ–°åˆçº¦ä¸­ä½¿ç”¨try-catch ï¼ˆåˆçº¦åˆ›å»ºè¢«è§†ä¸ºexternal callï¼‰
// executeNew(0)ä¼šå¤±è´¥å¹¶é‡Šæ”¾`CatchEvent`
// executeNew(1)ä¼šå¤±è´¥å¹¶é‡Šæ”¾`CatchByte`
// executeNew(2)ä¼šæˆåŠŸå¹¶é‡Šæ”¾`SuccessEvent`
function executeNew(uint a) external returns (bool success) {
    try new OnlyEven(a) returns(OnlyEven _even){
        // callæˆåŠŸçš„æƒ…å†µä¸‹
        emit SuccessEvent();
        success = _even.onlyEven(a);
    } catch Error(string memory reason) {
        // catchå¤±è´¥çš„ revert() å’Œ require()
        emit CatchEvent(reason);
    } catch (bytes memory reason) {
        // catchå¤±è´¥çš„ assert()
        emit CatchByte(reason);
    }
}
```

å€‹äººæ„Ÿè¦ºé€™è£¡çš„ try catch æ›´æœ‰ switch çš„å‘³é“ï¼Œä½†åˆä¸æ˜¯ï¼Œæ„Ÿè¦ºæ˜¯æœ‰å€‹é›åº•ä¸‹å»åšéŒ¯èª¤çš„å‘ˆç¾